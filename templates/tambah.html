<!-- templates/tambah.html -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h2>➕ Tambah Data Penduduk</h2>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ request.args.get('back_url') or url_for('index') }}">Beranda</a></li>
            <li class="breadcrumb-item active" aria-current="page">Tambah Data</li>
        </ol>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="post" class="bg-white p-4 rounded shadow-sm">
        <!-- Simpan back_url untuk kembali ke posisi semula -->
        <input type="hidden" name="back_url" value="{{ request.args.get('back_url') or url_for('index') }}">

        <div class="row">
            <!-- Nomor KK -->
            <div class="col-md-6 mb-3">
                <label for="nomor_kk" class="form-label">Nomor KK <span class="text-danger">*</span></label>
                <input type="text"
                       name="nomor_kk"
                       id="nomor_kk"
                       class="form-control"
                       oninput="validateNumber(this, 16)"
                       maxlength="16"
                       required>
                <small class="text-muted">16 digit angka</small>
                <div class="text-danger small mt-1" id="kk-error"></div>
            </div>

            <!-- NIK -->
            <div class="col-md-6 mb-3">
                <label for="nik" class="form-label">NIK <span class="text-danger">*</span></label>
                <input type="text"
                       name="nik"
                       id="nik"
                       class="form-control"
                       oninput="validateNumber(this, 16)"
                       maxlength="16"
                       required>
                <small class="text-muted">16 digit angka</small>
                <div class="text-danger small mt-1" id="nik-error"></div>
            </div>

            <!-- Nama -->
            <div class="col-md-6 mb-3">
                <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                <input type="text"
                       name="nama"
                       id="nama"
                       class="form-control"
                       oninput="validateNama(this)"
                       required>
                <div class="text-danger small mt-1" id="nama-error"></div>
            </div>

            <!-- Hubungan -->
            <div class="col-md-6 mb-3">
                <label for="hubungan" class="form-label">Hubungan <span class="text-danger">*</span></label>
                <select name="hubungan" id="hubungan" class="form-select" required>
                    <option value="">-- Pilih --</option>
                    <option value="Kepala Keluarga">Kepala Keluarga</option>
                    <option value="Istri">Istri</option>
                    <option value="Anak">Anak</option>
                    <option value="Orang Tua">Orang Tua</option>
                    <option value="Menantu">Menantu</option>
                    <option value="Cucu">Cucu</option>
                    <option value="Famili Lain">Famili Lain</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>

            <!-- Jenis Kelamin -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Jenis Kelamin <span class="text-danger">*</span></label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="jenis_kelamin" value="L" id="jk-l" required>
                        <label class="form-check-label" for="jk-l">Laki-laki</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="jenis_kelamin" value="P" id="jk-p">
                        <label class="form-check-label" for="jk-p">Perempuan</label>
                    </div>
                </div>
            </div>

            <!-- Dusun -->
            <div class="col-md-6 mb-3">
                <label class="form-label">Dusun <span class="text-danger">*</span></label>
                <div class="d-flex flex-wrap gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dusun" value="SATU" id="dusun1" required>
                        <label class="form-check-label" for="dusun1">SATU</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dusun" value="DUA" id="dusun2">
                        <label class="form-check-label" for="dusun2">DUA</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dusun" value="TIGA" id="dusun3">
                        <label class="form-check-label" for="dusun3">TIGA</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dusun" value="EMPAT" id="dusun4">
                        <label class="form-check-label" for="dusun4">EMPAT</label>
                    </div>
                </div>
            </div>

            <!-- Tempat & Tanggal Lahir -->
            <div class="col-md-6 mb-3">
                <label for="tempat_lahir" class="form-label">Tempat Lahir</label>
                <input type="text" name="tempat_lahir" class="form-control">
            </div>
            <div class="col-md-6 mb-3">
                <label for="tanggal_lahir" class="form-label">Tanggal Lahir</label>
                <input type="date" name="tanggal_lahir" class="form-control">
            </div>

            <!-- Agama -->
            <div class="col-md-6 mb-3">
                <label for="agama" class="form-label">Agama</label>
                <select name="agama" class="form-select">
                    <option value="">-- Pilih --</option>
                    <option value="Islam">Islam</option>
                    <option value="Kristen">Kristen</option>
                    <option value="Katolik">Katolik</option>
                    <option value="Hindu">Hindu</option>
                    <option value="Buddha">Buddha</option>
                    <option value="Konghucu">Konghucu</option>
                </select>
            </div>

            <!-- Status Perkawinan -->
            <div class="col-md-6 mb-3">
                <label for="status_perkawinan" class="form-label">Status Perkawinan</label>
                <select name="status_perkawinan" class="form-select">
                    <option value="">-- Pilih --</option>
                    <option value="Belum Kawin">Belum Kawin</option>
                    <option value="Kawin">Kawin</option>
                    <option value="Cerai Hidup">Cerai Hidup</option>
                    <option value="Cerai Mati">Cerai Mati</option>
                </select>
            </div>

            <!-- Pendidikan -->
            <div class="col-md-6 mb-3">
                <label for="pendidikan" class="form-label">Pendidikan</label>
                <select name="pendidikan" class="form-select">
                    <option value="">-- Pilih --</option>
                    <option value="Tidak/Belum Sekolah">Tidak/Belum Sekolah</option>
                    <option value="Belum Tamat SD/Sederajat">Belum Tamat SD/Sederajat</option>
                    <option value="Tamat SD/Sederajat">Tamat SD/Sederajat</option>
                    <option value="SLTP/Sederajat">SLTP/Sederajat</option>
                    <option value="SLTA/Sederajat">SLTA/Sederajat</option>
                    <option value="Diploma I/II">Diploma I/II</option>
                    <option value="Diploma III">Diploma III</option>
                    <option value="Diploma IV/Strata I">Diploma IV/Strata I</option>
                    <option value="Strata II">Strata II</option>
                    <option value="Strata III">Strata III</option>
                </select>
            </div>

            <!-- Pekerjaan -->
            <div class="col-md-6 mb-3">
                <label for="pekerjaan" class="form-label">Pekerjaan</label>
                <select name="pekerjaan" class="form-select">
                    <option value="">-- Pilih Pekerjaan --</option>
                    <option value="Belum/Tidak Bekerja">Belum/Tidak Bekerja</option>
                    <option value="Mengurus Rumah Tangga">Mengurus Rumah Tangga</option>
                    <option value="Pelajar/Mahasiswa">Pelajar/Mahasiswa</option>
                    <option value="Pegawai Negeri Sipil">Pegawai Negeri Sipil</option>
                    <option value="Petani/Pekebun">Petani/Pekebun</option>
                    <option value="Wiraswasta">Wiraswasta</option>
                    <option value="Karyawan BUMD">Karyawan BUMD</option>
                    <option value="Karyawan Swasta">Karyawan Swasta</option>
                    <option value="Buruh Harian Lepas">Buruh Harian Lepas</option>
                    <option value="Bidan">Bidan</option>
                    <option value="Sopir">Sopir</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>

            <!-- Alamat -->
            <div class="col-md-6 mb-3">
                <label for="alamat" class="form-label">Alamat</label>
                <input type="text" name="alamat" class="form-control">
            </div>

            <!-- RT/RW -->
            <div class="col-md-6 mb-3">
                <label for="rt_rw" class="form-label">RT/RW</label>
                <input type="text" name="rt_rw" class="form-control" placeholder="001/002">
            </div>

            <!-- Golongan Darah -->
            <div class="col-md-6 mb-3">
                <label for="golongan_darah" class="form-label">Gol. Darah</label>
                <select name="golongan_darah" class="form-select">
                    <option value="">Tidak Tahu</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="AB">AB</option>
                    <option value="O">O</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>

            <!-- Program Kesejahteraan -->
            <div class="col-12 mb-3">
                <label class="form-label">Program Kesejahteraan</label>
                <div class="row g-2">
                    {% for program in programs %}
                    <div class="col-md-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="kesejahteraan" value="{{ program }}" id="prog_{{ loop.index }}">
                            <label class="form-check-label" for="prog_{{ loop.index }}">{{ program }}</label>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Tombol -->
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">💾 Simpan Data</button>
            <a href="{{ request.args.get('back_url') or url_for('index') }}" class="btn btn-secondary">⬅️ Batal</a>
        </div>
    </form>
</div>

<!-- Script Validasi -->
<script>
// Validasi NIK & KK: hanya angka, wajib 16 digit
function validateNumber(input, length) {
    let errorDiv = document.getElementById(input.id + '-error');
    let value = input.value.replace(/[^0-9]/g, '');
    input.value = value;

    if (value.length > 0 && value.length !== length) {
        errorDiv.innerText = `Harus ${length} digit.`;
    } else {
        errorDiv.innerText = "";
    }
}

// Validasi Nama: hanya huruf & spasi, otomatis kapital
function validateNama(input) {
    let errorDiv = document.getElementById('nama-error');
    let value = input.value;

    let clean = value.replace(/[^a-zA-Z\s]/g, '');
    if (clean !== value) {
        input.value = clean;
        errorDiv.innerText = "Hanya huruf dan spasi yang diperbolehkan.";
        return;
    }

    if (clean && clean !== clean.toUpperCase()) {
        input.value = clean.toUpperCase();
    }
    errorDiv.innerText = "";
}
</script>

{% endblock %}